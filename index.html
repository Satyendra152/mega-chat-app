<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEGA - Voice Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .join-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        input {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .join-btn {
            background: linear-gradient(135deg, #4CD964, #5DE876);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .join-btn:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, #3BD955, #4CD964);
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 80vh;
            max-width: 800px;
            width: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chat-header {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .voice-btn {
            background: #4CD964;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .voice-btn.off {
            background: #FF6B6B;
        }

        .voice-btn:hover {
            transform: scale(1.05);
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .blink {
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .channels-sidebar {
            width: 200px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .channel {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .channel.active {
            background: rgba(255,255,255,0.2);
            font-weight: 600;
        }

        .channel:hover {
            background: rgba(255,255,255,0.15);
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 15px;
            border-radius: 15px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            background: rgba(76, 217, 100, 0.3);
            margin-left: auto;
            border: 1px solid rgba(76, 217, 100, 0.5);
        }

        .message.other {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .message.system {
            background: rgba(255, 193, 7, 0.3);
            text-align: center;
            border: 1px solid rgba(255, 193, 7, 0.5);
            max-width: 100%;
        }

        .message.voice {
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .username {
            font-weight: 600;
        }

        .voice-icon {
            color: #4CD964;
        }

        .input-area {
            padding: 20px;
            background: rgba(255,255,255,0.15);
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 1rem;
        }

        .send-btn {
            background: #4CD964;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #3BD955;
            transform: scale(1.05);
        }

        .voice-send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-send-btn:hover {
            background: #5a6fd8;
            transform: scale(1.05);
        }

        .voice-send-btn.recording {
            background: #FF6B6B;
            animation: pulse 0.8s infinite;
        }

        .users-online {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
        }

        .user-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .user-speaking {
            background: rgba(76, 217, 100, 0.3);
        }

        .speaking-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CD964;
            margin-left: auto;
            animation: blink 1s infinite;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .chat-container {
                height: 90vh;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Join Screen -->
    <div class="container" id="joinScreen">
        <div class="header">
            <div class="logo">🎤</div>
            <h1>MEGA VOICE CHAT</h1>
            <p>Join and speak with others in real-time</p>
        </div>
        
        <div class="join-form">
            <div class="form-group">
                <label for="serverCode">Server Code</label>
                <input type="text" id="serverCode" placeholder="Enter MEGA-ABCD" value="MEGA-7A9B">
            </div>
            
            <div class="form-group">
                <label for="userName">Your Name</label>
                <input type="text" id="userName" placeholder="Enter your username">
            </div>
            
            <button class="join-btn" onclick="joinChat()">
                <i class="fas fa-sign-in-alt"></i> Join Voice Chat
            </button>
        </div>
    </div>

    <!-- Chat Screen -->
    <div class="chat-container" id="chatScreen">
        <div class="chat-header">
            <div class="server-info">
                <i class="fas fa-server"></i>
                <span id="currentServer">MEGA-7A9B</span>
            </div>
            
            <div class="voice-controls">
                <div class="voice-indicator" id="voiceStatus">
                    <i class="fas fa-microphone"></i>
                    <span>Voice Ready</span>
                </div>
                <button class="voice-btn" id="toggleVoiceBtn" onclick="toggleVoice()">
                    <i class="fas fa-microphone"></i>
                    Voice On
                </button>
            </div>
        </div>

        <div style="display: flex; flex: 1;">
            <div class="channels-sidebar">
                <h3>Channels</h3>
                <div class="channel active"># general</div>
                <div class="channel"># 🔊 voice-chat</div>
                <div class="channel"># 🎮 gaming</div>
                <div class="channel"># 🎵 music</div>
                
                <div class="users-online">
                    <h4>Online Users</h4>
                    <div id="usersList">
                        <!-- Users will be added here -->
                    </div>
                </div>
            </div>

            <div class="main-chat">
                <div class="messages" id="messagesContainer">
                    <!-- Messages will appear here -->
                </div>
                
                <div class="input-area">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type your message...">
                    <button class="voice-send-btn" id="voiceSendBtn" onclick="toggleVoiceRecording()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = '';
        let currentServer = '';
        let isVoiceEnabled = true;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let peerConnections = new Map();
        let localStream = null;

        // Join chat function
        function joinChat() {
            const serverCode = document.getElementById('serverCode').value.trim().toUpperCase();
            const userName = document.getElementById('userName').value.trim();

            if (!userName) {
                alert('Please enter your name');
                return;
            }

            if (!serverCode.startsWith('MEGA-')) {
                alert('Please enter a valid server code starting with MEGA-');
                return;
            }

            currentUser = userName;
            currentServer = serverCode;

            // Show chat screen
            document.getElementById('joinScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            document.getElementById('currentServer').textContent = serverCode;

            // Initialize chat
            initializeChat();
            initializeVoiceChat();
        }

        // Initialize chat
        function initializeChat() {
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Add welcome messages
            addSystemMessage(`Welcome to ${currentServer}, ${currentUser}!`);
            addSystemMessage('Voice chat is enabled. Click the microphone button to speak.');
            
            // Add sample users
            updateUsersList([
                { name: 'Alex', isSpeaking: false },
                { name: 'Sam', isSpeaking: true },
                { name: currentUser, isSpeaking: false, isYou: true }
            ]);

            // Add sample messages
            setTimeout(() => {
                addMessage('Alex', 'Hello everyone! Voice chat is working great!', false);
            }, 1000);

            setTimeout(() => {
                addMessage('Sam', 'I can hear you clearly! 🎧', false);
            }, 2000);
        }

        // Initialize voice chat
        async function initializeVoiceChat() {
            try {
                // Request microphone permission
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('Microphone access granted');
                
                // Setup media recorder for voice messages
                setupMediaRecorder();
                
            } catch (error) {
                console.error('Microphone access denied:', error);
                alert('Microphone access is required for voice chat. Please allow microphone permission.');
                isVoiceEnabled = false;
                updateVoiceUI();
            }
        }

        // Setup media recorder
        function setupMediaRecorder() {
            if (!localStream) return;

            mediaRecorder = new MediaRecorder(localStream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                // Create audio blob and play it (simulating voice message)
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Add voice message to chat
                addVoiceMessage(currentUser, audioUrl);
                
                // Simulate other users hearing the voice
                simulateVoiceBroadcast();
            };
        }

        // Toggle voice on/off
        function toggleVoice() {
            isVoiceEnabled = !isVoiceEnabled;
            updateVoiceUI();
            
            if (isVoiceEnabled) {
                addSystemMessage('Voice chat enabled');
            } else {
                addSystemMessage('Voice chat disabled');
                stopRecording();
            }
        }

        // Update voice UI
        function updateVoiceUI() {
            const voiceBtn = document.getElementById('toggleVoiceBtn');
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceSendBtn = document.getElementById('voiceSendBtn');

            if (isVoiceEnabled) {
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> Voice On';
                voiceBtn.classList.remove('off');
                voiceStatus.innerHTML = '<i class="fas fa-microphone"></i> Voice Ready';
                voiceSendBtn.disabled = false;
            } else {
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> Voice Off';
                voiceBtn.classList.add('off');
                voiceStatus.innerHTML = '<i class="fas fa-microphone-slash"></i> Voice Off';
                voiceSendBtn.disabled = true;
            }
        }

        // Toggle voice recording
        function toggleVoiceRecording() {
            if (!isVoiceEnabled) {
                alert('Please enable voice chat first');
                return;
            }

            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        // Start recording
        function startRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'recording') return;

            audioChunks = [];
            mediaRecorder.start();
            isRecording = true;

            // Update UI
            const voiceSendBtn = document.getElementById('voiceSendBtn');
            voiceSendBtn.classList.add('recording');
            voiceSendBtn.innerHTML = '<i class="fas fa-stop"></i>';
            
            // Show recording indicator
            updateUserSpeaking(currentUser, true);
            
            addSystemMessage('Recording... Speak now!');
        }

        // Stop recording
        function stopRecording() {
            if (!mediaRecorder || mediaRecorder.state !== 'recording') return;

            mediaRecorder.stop();
            isRecording = false;

            // Update UI
            const voiceSendBtn = document.getElementById('voiceSendBtn');
            voiceSendBtn.classList.remove('recording');
            voiceSendBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            
            // Hide speaking indicator
            updateUserSpeaking(currentUser, false);
        }

        // Simulate voice broadcast to other users
        function simulateVoiceBroadcast() {
            const users = ['Alex', 'Sam', 'Jordan'];
            
            users.forEach(user => {
                if (user !== currentUser) {
                    // Random delay to simulate real-time
                    setTimeout(() => {
                        updateUserSpeaking(user, true);
                        
                        // Add voice heard message
                        setTimeout(() => {
                            addMessage(user, 'I can hear you! 🔊', false);
                            updateUserSpeaking(user, false);
                        }, 1000);
                    }, Math.random() * 1000);
                }
            });
        }

        // Send text message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (message) {
                addMessage(currentUser, message, true);
                messageInput.value = '';

                // Simulate replies
                simulateReply();
            }
        }

        // Add text message
        function addMessage(sender, text, isOwn = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${sender}</span>
                    ${!isOwn ? '<i class="fas fa-user"></i>' : ''}
                </div>
                <div class="message-text">${text}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add voice message
        function addVoiceMessage(sender, audioUrl) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message voice own';
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${sender}</span>
                    <i class="fas fa-microphone voice-icon blink"></i>
                </div>
                <div class="message-text">
                    Voice message
                    <audio controls style="margin-top: 8px; width: 100%;">
                        <source src="${audioUrl}" type="audio/wav">
                    </audio>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Auto play after a delay (simulating real voice chat)
            setTimeout(() => {
                const audio = messageDiv.querySelector('audio');
                if (audio) {
                    audio.play().catch(e => console.log('Auto-play prevented'));
                }
            }, 500);
        }

        // Add system message
        function addSystemMessage(text) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = text;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Update users list
        function updateUsersList(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = `user-item ${user.isSpeaking ? 'user-speaking' : ''} ${user.isYou ? 'you' : ''}`;
                
                userDiv.innerHTML = `
                    <div class="user-avatar">${user.name.charAt(0)}</div>
                    <span>${user.name} ${user.isYou ? '(You)' : ''}</span>
                    ${user.isSpeaking ? '<div class="speaking-indicator blink"></div>' : ''}
                `;

                usersList.appendChild(userDiv);
            });
        }

        // Update user speaking status
        function updateUserSpeaking(userName, isSpeaking) {
            const users = Array.from(document.querySelectorAll('.user-item'));
            const userItem = users.find(item => item.textContent.includes(userName));
            
            if (userItem) {
                if (isSpeaking) {
                    userItem.classList.add('user-speaking');
                    if (!userItem.querySelector('.speaking-indicator')) {
                        userItem.innerHTML += '<div class="speaking-indicator blink"></div>';
                    }
                } else {
                    userItem.classList.remove('user-speaking');
                    const indicator = userItem.querySelector('.speaking-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            }
        }

        // Simulate reply from other users
        function simulateReply() {
            const replies = [
                "That's interesting!",
                "I agree with you!",
                "Thanks for sharing!",
                "What do you think about this?",
                "That's awesome! 👍"
            ];

            const users = ['Alex', 'Sam', 'Jordan'];
            const randomUser = users[Math.floor(Math.random() * users.length)];
            const randomReply = replies[Math.floor(Math.random() * replies.length)];

            setTimeout(() => {
                addMessage(randomUser, randomReply, false);
            }, 1000 + Math.random() * 2000);
        }

        // Handle Enter key for sending messages
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize voice UI
        updateVoiceUI();
    </script>
</body>
</html>
